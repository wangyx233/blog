---
title: 【浏览器】从输入URL到页面展示发生了什么？
categories: ["浏览器"]
toc: true
---

> 前置知识：目前浏览器都有哪些进程？

- 浏览器主进程
- 渲染进程：默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中。
- 网络进程
- GPU 进程
- 插件进程

> 1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程

多进程模型提升了浏览器的稳定性、流畅性和安全性。但同样不可避免地带来了一些问题，更高的资源占用，更复杂的体系架构。
为了解决这些问题，在 2016 年，Chrome 官方团队使用“面向服务的架构”（Services Oriented Architecture，简称 SOA）的思想设计了新的 Chrome 架构。原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统。
浏览器的主进程，渲染进程，插件进程。其他的变成基本服务，比如，网络进程、GPU 进程、Audio 进程、Video 进程、文件进程、Profile 进程、UI 进程、设备进程...内存不够的系统中，会把相关的进程都合并进主进程。

1. 用户输入 url 并回车
2. 浏览器进程检查 url，组装协议，构成完整的 url
3. 浏览器进程通过进程间通信（IPC）把 url 请求发送给网络进程
4. 网络进程接收到 url 请求后检查本地缓存是否缓存了该请求资源，如果有则将该资源返回给浏览器进程
5. 如果没有，网络进程向 web 服务器发起 http 请求（网络请求），请求流程如下：

- 进行 DNS 解析，获取服务器 ip 地址，端口（端口是输入的，没输入 http 80，https 443)，如果请求协议是 HTTPS，那么还需要建立 TLS 连接
- 利用 ip 地址和服务器建立 tcp 连接
- 构建请求头信息
- 发送请求头信息
- 服务器响应后，网络进程接收响应头和响应信息，并解析响应内容

6. 网络进程解析响应流程；

- 检查状态码，如果是 301/302，则需要重定向，从 Location 自动中读取地址，重新进行第 4 步 （301/302 跳转也会读取本地缓存），如果是 200，则继续处理请求。
- 200 响应处理：检查响应类型 Content-Type，如果是字节流类型(application/octet-stream)，则将该请求提交给下载管理器，该导航流程结束，不再进行后续的渲染，如果是 html 则通知浏览器进程准备渲染进程准备进行渲染。

7. 准备渲染进程

- 浏览器进程检查当前 url 是否和之前打开的渲染进程根域名是否相同，如果相同，则复用原来的进程，如果不同，则开启新的渲染进程(process-per-site-instance)

8. 传输数据、更新状态。

- 渲染进程准备好后，浏览器向渲染进程发起“提交文档”的消息，渲染进程接收到消息和网络进程建立传输数据的“管道”
- 渲染进程接收完数据后，向浏览器发送“确认提交”
- 浏览器进程接收到确认消息后更新浏览器界面状态：安全、地址栏 url、前进后退的历史状态、更新 web 页面

总体来说，分为网络请求和渲染两大部分，即导航流程和渲染流程。
